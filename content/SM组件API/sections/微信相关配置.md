---
title: 微信相关配置
---
`使用DeviceOne接入微信开放平台，可使用微信登录、分享和支付功能`

* [一、公共设置](#一)
* [二、登录功能](#二)
* [三、分享功能](#三)
* [四、支付功能](#四)
* [五、示例代码](#五)
* [六、常见问题处理](#六)
* [七、讨论交流](#七)

<h2 id="一">一、公共设置</h2>
#### 1. 创建应用
登录微信开发者的网址：https://open.weixin.qq.com/ ，点击“管理中心”-“创建移动应用”
 ![](../../images/wxxg001.png)

#### 2. 填写应用信息
* ##### 2.1 填写基本信息
根据需要填写基本信息，即使是调试用也尽量使用真实数据，增大应用通过审核的几率，否则应用不通过微信平台审核，无法正常使用登录、分享和支付功能。

* ##### 2.2 填写平台信息
勾选需要使用的平台，由于DeviceOne平台是从windows10开始支持，而微信开放平台支持的windows是windows8，故勾选了“WP8”也无法在DO平台使用。

* ###### 2.2.1 选择iOS应用
 ![](../../images/wxxg002.png)
这里的BundleID是指iOS应用的唯一标识，是跟苹果证书绑定的，一个证书对应了一个BundleID，填写后需要记住，之后在DO平台中还需要使用。
**需要注意的是，平时调试其他组件可以使用DO提供的默认证书，但调试和发布待第三方组件的应用时，必须要使用自己申请的苹果证书。关于证书的说明，详见http://doc.deviceone.net/web/doc/detail_course/certificate.htm**

* ###### 2.2.2 选择Android应用
选择了Android应用，需要填写的最重要的两项分别是“应用签名”与“应用包名”，由于签名与包名相关，这里先说明包名如何填写。
 ![](../../images/wxxg003.png)
* 2.2.2.1 应用包名
Android的应用包名与iOS的BundleID相同，也是标示应用唯一性的，不同于iOS需要购买证书，Android的证书创建非常简便，如果开发者没有Android证书，可以在DO平台中快速创建一个，记住创建证书时填写的包名，比如这里创建一个包名为**“com.test.test1”**、证书名称为“微信测试”的证书。
然后将包名“com.test.test1”填写在上图1的位置中。
 ![](../../images/wxxg004.png)

* 2.2.2.2 应用签名
需要在Android平台中填写的应用签名，是从安装在手机中的应用中获取的，要获取正确的签名，首先需要在DO平台打一个安装包，可以是调试包，也可以是发布包，**唯一的要求是这个包所使用证书的包名是跟在2.2.2.1中填写的应用包名相同的。所以我们在DO平台填写应用配置时，“证书安全”一项中选择上面我们创建的名称为“微信测试”的证书，即包名也为“com.test.test1”的证书，这样根据包名获取到的签名就是正确的了。**
 ![](../../images/wxxg005.png)
安装完之后，将“签名生成工具”也安装在同一个设备中，打开“签名生成工具”，输入包名，如“com.test.test1”，然后点击“Get Signature”获取签名，最后将获取到的签名输入到2.2.2中所示图片应用签名的位置即可。
微信开放平台提供了“签名生成工具”的下载，下载页面如下图所示。
 ![](../../images/wxxg006.png)

#### 3. 应用提交审核
与大多数第三方组件开放平台相同，微信开放平台也需要应用通过审核才可正常使用功能，否则的话只能用作调试。

#### 4. 开通接口
申请好应用，在移动应用列表中点击“查看”进入应用详细页面，可以看到此时应用的接口信息，若“分享到朋友圈”、“发送给朋友”、“微信支付”、“微信登录”这四项功能的接口状态为“未获得”，在使用DO平台的do_TencetWX组件相应功能时会有问题，用户可根据自己的需要，申请开通接口。
![](../../images/wxxg007.png)


#### 5. DeviceOne平台中的配置
* ##### 5.1 配置iOS平台
* ###### 5.1.1 填写组件秘钥
复制申请好应用后的应用AppID，
![](../../images/wxxg008.png)

在DO平台应用配置的“组件配置”中添加do_TencetWX组件，再在组件列表中点击组件后面的小钥匙图标，打开秘钥设置，将应用的AppID填写进去
![](../../images/wxxg009.png)

* ###### 5.1.2 填写应用跳转配置
平台配置中，选择iOS的选项卡，在底下“应用唤醒ID”出点击“添加”按钮，
![](../../images/wxxg010.png)
将上一步中的AppID填写在“Scheme”项中，这是用于应用跳转到第三方，处理完业务还可再跳转回DeviceOne应用的关键，其他项的“唤醒名称”是唤醒ID的中文名称标识，可以起一个好辨认的，另外的“Url Identifer”是唤醒ID的英文标识，暂时没有限制。
![](../../images/wxxg011.png)

* ###### 5.1.3 选择证书
填写完组件的配置，最后要配置的是证书，在“证书安全”选择在“一、公共设置，2.2.1”中填写的bundleID相对应的那个证书。

* ###### 5.1.4 重新打包
填写完所有配置项，一定要记得重新打包，重新安装，才可将刚刚的配置全部包含进应用中。

* ##### 5.2 配置Android平台
* ###### 5.2.1 选择证书
Android平台的配置相较于iOS平台来说相对简单，只需在“证书安全”中选择在“一、公共设置，2.2.2”中填写的包名相对应的那个证书。

* ###### 5.2.2 重新打包
同样的，填写完Android的所有配置项，也要重新打包。

到此为止，所有的配置都已经完成，安装好调试版，下面进入功能实现介绍。

<h2 id="二">二、登录功能</h2>
登录是最基础的一个功能，也是最为容易实现的功能。在完成上述配置并安装好调试包后，只需要在调用do_TencetWX组件的login方法时，在appId参数中传我们之前在微信开放平台中申请应用后显示的AppID，**（注意如果同时创建了多个应用，一定要注意当前调试包所使用的证书、包名和bundleID等是否与开放平台上应用中上传的bundleID和包名相对应。）**之后即可正常使用登录功能，如果想要获取用户信息，可以拿在登录成功情况下login方法的返回值中的code去调用微信开放平台提供的接口来获取access_token，进而在有效时间内换取用户信息。
![](../../images/wxxg012.png)

<h2 id="三">三、分享功能</h2>
DeviceOne平台开发的do_TencetWX组件提供两种分享功能，一个是分享给微信好友，另外一个是分享到朋友圈，都是通过share方法实现的，share方法的调用比较简单，仅需要注意某些参数的限制，如type参数为1时仅支持本地图片等等。

<h2 id="四">四、支付功能</h2>
#### 1. 支付原理
**想要使用支付功能，前提必须要应用通过审核，且开通支付接口。**
支付功能看起来参数很多，实际上原理相当简单，如下图所示：用户自己搭建商户后台，使用支付相关数据去请求微信开放平台的“统一下单”接口https://api.mch.weixin.qq.com/pay/unifiedorder ，请求的参数及详细介绍见文档 https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1 正确请求后，微信开放平台会生成预付单并返回预付单信息，其中包含支付信息的字段“prepay_id”，此时商户后台再生成带签名的客户端支付信息，等待移动端调起支付时，商户后台把“prepay_id”及其他一些必要参数传入，在用户同意支付之后即可完成支付。
![](../../images/wxxg013.png)
更详细支付流程见https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3

#### 2. 获取商户号
登录商户平台 https://pay.weixin.qq.com/index.php/account  获取商户平台的商户号
![](../../images/wxxg014.png)
处于安全考虑，点击API安全->设置密钥 设置一个新的密钥（APIKey）
![](../../images/wxxg015.png)

#### 3. 参数介绍
详细介绍pay方法的各个参数分别是什么，及如何填写
![](../../images/wxxg016.png)

#### 4. 商户后台参考代码
服务端获取prepare_id后，进行简单签名的参考代码
![](../../images/wxxg017.png)

#### 5. 支付验证测试
如果用户还未搭建相应后台，暂时只想测试下微信支付的功能，这里一个工具，将你的AppID、商户号及API秘钥填入，就能自动生成调用DeviceOne微信的pay方法所需的参数了。[工具下载](/web/zip/20160511/1b0b435ab1f547d6812516cd5c171a45.zip)
 ![](../../images/wxxg018.png)


<h2 id="五">五、常见问题处理</h2>
#### 1. 调功能没有反应
原因一般有两种，第一要检查所使用的AppID、证书、包名和BundleID是否相对应，99%的没有反应都是因为配置原因，尤其是Android平台的签名，必须是相同包名的签名。
**如果配置都没有问题，基本归属于第二种情况，设备中没有安装微信客户端，这是由于第三方平台的sdk要求的，DeviceOne平台无法处理，但我们提供了一个方法“isWXAppInstalled”，可以检测出当前设备中是否安装微信客户端。**

#### 2. 分享网络图片失败
由于微信sdk版本限制，分享网络图片时，大小不能超过32k，否则会分享失败

#### 3. Android之前登录成功过，切换账号后无法再次登录
由于Android平台的机制与iOS不同，会将使用过的账号信息缓存下来，发生这种情况时，可以打开手机的“设置”-“应用管理”-“微信”-“清除数据”，再重新登录下即可。

#### 4. 功能没有反应
检查设备上安装的微信客户端版本是否过低，升级到最新版再尝试。

#### 5. DO网站中证书管理的sha1值是否是微信后台需要的签名？
不是，DO网站中的sha1值是用于一些第三方组件后台配置所需，而微信后台的签名是需要通过微信官方提供的签名生成工具生成的，二者不是同一个东西。[微信签名工具地址](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419319167&token=&lang=zh_CN)


[回到顶部](#top)
